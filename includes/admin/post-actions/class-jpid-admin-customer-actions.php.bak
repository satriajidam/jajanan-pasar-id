<?php

/**
 * Customer admin actions manager.
 *
 * @since      1.0.0
 * @package    jajanan-pasar-id
 * @subpackage jajanan-pasar-id/includes/admin/post-actions
 * @author		 Agastyo Satriaji Idam <play.satriajidam@gmail.com>
 */

// Exit if accessed directly
if ( ! defined( 'ABSPATH' ) ) exit;

class JPID_Admin_Customer_Actions {

  /**
   * @since    1.0.0
   * @var      string    Nonce action.
   */
  const NONCE_ACTION = 'jpid_save_customer';

  /**
   * @since    1.0.0
   * @var      string    Nonce name.
   */
  const NONCE_NAME = 'jpid_customer_nonce';

  /**
   * @since    1.0.0
   * @var      array    Customer ID to processed.
   */
  private $customer_id;

  /**
   * @since    1.0.0
   * @var      array    Customer data to processed.
   */
  private $customer_data;

  /**
	 * Class constructor.
	 *
	 * @since    1.0.0
	 */
  public function __construct( $customer_id, $customer_data ) {
    $this->customer_id   = $customer_id;
    $this->customer_data = $customer_data;
  }

  /**
   * Save customer action.
   *
   * @since    1.0.0
   */
  public function save_customer() {
    if ( empty( $this->customer_data ) ) {
      wp_die( __( 'No customer data provided.', 'jpid' ) );
    }

    if ( ! $this->can_save() ) {
      wp_die( __( 'You do not have permission to edit this customer.', 'jpid' ) );
    }

    $customer_data = $this->prepare_customer_data();

    if ( $this->customer_id > 0 ) {

      $customer = new JPID_Customer( $this->customer_id );

    } else {

      if ( ! array_key_exists( 'customer_email', $customer_data ) ) {

        if ( empty( $customer_data['customer_email'] ) || ! is_email( $customer_data['customer_email'] ) ) {
          return;
        }

        return;
      }

      $customer = new JPID_Customer();

    }

    $new_customer_id = $customer->save( $customer_data );

    if ( $new_customer_id ) {

      $customer_edit_page = admin_url() . 'admin.php?page=' . JPID_Admin_Page_Customer_Edit::SLUG . '&customer=' . $new_customer_id;

      wp_safe_redirect( $customer_edit_page );

    } else {

    }
  }

  /**
   * Sanitize and check customer data validity before being saved.
   *
   * @since     1.0.0
   * @return    array    Collection of processed customer data.
   */
  private function prepare_customer_data() {
    $customer_data = array();

    if ( ! empty( $this->customer_data['jpid_user_id'] ) ) {
      $user_id = absint( $this->customer_data['jpid_user_id'] );

      // Check if user ID already attached to certain customer
      $customer = jpid_get_customer_by( 'user_id', $user_id );

      if ( empty( $customer ) ) {
        return;
      }

      // Check if actual user accpunt exists
      $user = get_user_by( 'id', $user_id );

      if ( empty( $user ) ) {
        return;
      }

      $customer_data['user_id'] = $user_id;
    }

    if ( ! empty( $this->customer_data['jpid_customer_name'] ) ) {
      $customer_data['customer_name'] = sanitize_text_field( trim( $this->customer_data['jpid_customer_name'] ) );
    }

    if ( ! empty( $this->customer_data['jpid_customer_email'] ) ) {
      $customer_data['customer_email'] = sanitize_email( trim( $this->customer_data['jpid_customer_email'] ) );
    }

    if ( ! empty( $this->customer_data['jpid_customer_phone'] ) ) {
      $customer_data['customer_phone'] = sanitize_text_field( trim( $this->customer_data['jpid_customer_phone'] ) );
    }

    if ( ! empty( $this->customer_data['jpid_customer_address'] ) ) {
      $customer_data['customer_address'] = sanitize_text_field( trim( $this->customer_data['jpid_customer_address'] ) );
    }

    if ( ! empty( $this->customer_data['jpid_customer_province'] ) ) {
      $customer_data['customer_province'] = sanitize_text_field( trim( $this->customer_data['jpid_customer_province'] ) );
    }

    if ( ! empty( $this->customer_data['jpid_customer_city'] ) ) {
      $customer_data['customer_city'] = sanitize_text_field( trim( $this->customer_data['jpid_customer_city'] ) );
    }

    return $customer_data;
  }

  /**
	 * Check if current edited customer can be saved.
	 *
	 * @since     1.0.0
	 * @return    boolean    True if customer can be saved, otherwise false.
	 */
  private function can_save() {
    $is_valid_nonce = isset( $this->customer_data[ self::NONCE_NAME ] ) && wp_verify_nonce( $this->customer_data[ self::NONCE_NAME ], self::NONCE_ACTION );
    $is_user_can    = is_admin() && current_user_can( 'edit_users' );

    return $is_valid_nonce && $is_user_can;
  }

  /**
   * Delete customer action.
   *
   * @since    1.0.0
   */
  public function delete_customer() {

  }

}
